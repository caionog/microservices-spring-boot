
services:
    mysql:
        image: mysql:8.0
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: microservices
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 10s
        ports:
            - "3307:3306"
        volumes:
            - mysql-data:/var/lib/mysql
        restart: unless-stopped
    account:
        build:
            context: ./4-account-service-gateway/
        depends_on:
            - discovery
    transaction:
        build:
            context: ./4-transaction-service-gateway/
        depends_on:
             - discovery
    patients:
        build:
            context: ./4-patients-service-gateway/
        depends_on:
             discovery:
                 condition: service_started
             mysql:
                 condition: service_healthy
        restart: on-failure
    doctors:
        build:
            context: ./4-doctors-service-gateway/
        depends_on:
             discovery:
                 condition: service_started
             mysql:
                 condition: service_healthy
        restart: on-failure
    discovery:
        build:
            context: ./3-service-discovery/
        ports:
            - "8761:8761"
    gateway:
        build:
            context: ./4-service-gateway
        ports:
             - "8084:8084"
        depends_on:
             - account
             - transaction
             - patients
             - doctors

volumes:
    mysql-data: