
services:
    mysql:
        image: mysql:8.0
        environment:
            MYSQL_ROOT_PASSWORD: root
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 10s
        ports:
            - "3307:3306"
        volumes:
            - mysql-data:/var/lib/mysql
            - ./init.sql:/docker-entrypoint-initdb.d/init.sql
        restart: unless-stopped
    
    postgres:
        image: postgres:15-alpine
        environment:
            POSTGRES_DB: keycloak
            POSTGRES_USER: keycloak
            POSTGRES_PASSWORD: keycloak
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U keycloak"]
            interval: 10s
            timeout: 5s
            retries: 5
        ports:
            - "5432:5432"
        volumes:
            - postgres-data:/var/lib/postgresql/data
        restart: unless-stopped
    
    keycloak:
        image: quay.io/keycloak/keycloak:24.0
        command: start-dev
        environment:
            KC_DB: postgres
            KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
            KC_DB_USERNAME: keycloak
            KC_DB_PASSWORD: keycloak
            KEYCLOAK_ADMIN: admin
            KEYCLOAK_ADMIN_PASSWORD: admin
        ports:
            - "8081:8080"
        depends_on:
            postgres:
                condition: service_healthy
        restart: unless-stopped
    account:
        build:
            context: ./4-account-service-gateway/
        depends_on:
            - discovery
    transaction:
        build:
            context: ./4-transaction-service-gateway/
        depends_on:
             - discovery
    patients:
        build:
            context: ./4-patients-service-gateway/
        depends_on:
             discovery:
                 condition: service_started
             mysql:
                 condition: service_healthy
        restart: on-failure
    doctors:
        build:
            context: ./4-doctors-service-gateway/
        depends_on:
             discovery:
                 condition: service_started
             mysql:
                 condition: service_healthy
        restart: on-failure
    appointment:
        build:
            context: ./5-appointment-service-gateway/
        ports:
             - "8086:8086"
        depends_on:
             discovery:
                 condition: service_started
             mysql:
                 condition: service_healthy
        restart: on-failure
    discovery:
        build:
            context: ./3-service-discovery/
        ports:
            - "8761:8761"
    gateway:
        build:
            context: ./4-service-gateway
        ports:
             - "8084:8084"
        environment:
            # Validação Lógica: aceita issuer-uri com localhost (clientes externos)
            SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://localhost:8081/realms/consultas-realm
            # Conexão Física: download das chaves usando rede interna Docker (mais rápido)
            SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/consultas-realm/protocol/openid-connect/certs
        depends_on:
             discovery:
                 condition: service_started
             keycloak:
                 condition: service_started
        restart: on-failure

volumes:
    mysql-data:
    postgres-data: